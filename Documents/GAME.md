
# Once Upon A Time

## Зміст
<!--ts-->
   * [Про гру](#про-гру)
   * [Архітектура](#архітектура)
   * [Автоматична генерація карти підземелля](#автоматична-генерація-карти-підземелля)
   * [Головний герой](#головний-герой)
   * [Вороги та штучний інтелект для їх руху](#вороги-та-штучний-інтелект-для-їх-руху)
<!--te-->

## Про гру
Командою було розроблено гру у жанрі Roguelike. Існує дві карти: місто та підземелля. Гравець має змогу грати за Ельфа, якого, знаходячись у місті, він готує до небезпечного (але прибуткового) походу в підземелля, де він нищитиме ворогів та зароблятиме золото...

## Архітектура
Гра була розроблена за архітектурою AMVCC. Детальніше можна ознайомитися за посиланням https://www.toptal.com/unity-unity3d/unity-with-mvc-how-to-level-up-your-game-development.

**Модель**

 1. Містить основні дані програми такі, як здоров'я або тип зброї гравця.
 2. Повідомляє контролер про прогрес операцій.
 3. Зберігає стан кінцевого автомата гри.

**Представлення**

 1. Може отримувати дані з моделі для відображення поточного стану гри. Наприклад, метод player.move() використовує model.speed для наочного відображення руху гравця.
 2. Ніколи не змінює Модель.
 3. Не зберігає важливих даних таких як: швидкість, здоров'я і таке інше.
 4. Ніколи на змінює стан гри.

**Контролер**

 1. Не зберігає дані гри.
 2. Може, інколи, "відкидати" повідомлення від небажаних *Представлень*.
 3. Оновлює та використовує дані з *Моделі*.
 4. Керує перебігом дій на сцені в Unity.

**Додаток**
Єдина точка входу до програми та контейнер всіх критичних екземплярів та даних, пов’язаних із додатком.

**Компонент**
Невелика, добре написаний скрипт, який можна використовувати повторно.

## Автоматична генерація карти підземелля
Власне кажучи, підземення не є однією картою, оскільки усе на рівні створюється автоматично, базуючись на налаштуваннях, щоразу, як карта перезавантажується. А саме генеруються наступні об'єтки:
* власне карта,
* вороги, монети, сердечка, двері переходу на наступний рівень та виходу з підземелля.

Зупинюся на кожному пункті детальніше.

### Генерація карти
Базовий принцип генерації рівня складається з двох послідовних процесів: генерація землі, та обнесення усієї землі блоками лісу.

Для генерації землі створюється об'єкт генератора на позиції (0, 0) та він починає "стрибати" в будь-яку з чотирьох сторін (вгору, вниз, вліво та вправо), переміщуючись при цьому на ширину блоку землі, що вказана в параметрах, де також зазначена вірогідність "стрибку" в кожну з 4-х сторін (див. Рисунок 1). Після "приземлення" на новій позиції генератора створюється блок землі, якщо там ще його немає. Процес зупиняється тоді, коли створено кількість блоків, що зазначена в параметрах.

![Генерація карти підземелля](https://github.com/kushkamisha/OnceUponATime/blob/master/Documents/level-generator.jpg)
<center>Рисунок 1. Генератор карти підземелля</center>

Після того, як земля створена знаходиться мінімальне та максимальне значення згенерованих блоків за кожною віссю (x та y). Від цих значень робиться відступ в стільки блоків, скільки вказано в параметрах та таким чином отримуються координати лісу та його розміри. Виходить прямокутник, в центрі якого - блоки землі, по яким переміщується герой та вороги. Отримавши ці значення генеруються блоки лісу в цьому прямокутнику там, де немає блоків землі.

### Створення ворогів, монет та сердечок
Базуючись на параметрах, на рівні випадковим чином розміщується певна кількість ворогів, до яких підв'язуються скрипти для їх "розумної" поведінки. Розміщення відбувається за таким критерієм: вибирається випадковий згенерований блок землі та обирається випадковим чином зміщення від центру цього блоку. На цій позиції і створюється ворог.

Аналогічним способом створюються монети, сердечка та двері переходу на наступний рівень та виходу з підземелля.

## Головний герой
Головним героєм цієї гри є Ельф. 
У Ельфа є три класи, а саме: PlayerController, PlayerView та PlayerModel.

В класі PlayerModel зберігається основна характеристика головного персонажа: сила, здоров'я, атака, тощо. Відображення анімацій атаки або руху, зменшення здоров'я - це відбувається у класі PlayerView. Насамкінець в класі PlayerController оброблюються усі дані, які були відправлені з класу PlayerModel.

Для анімації дій Ельфа використовується компонент Animator. Цей компонент використовується для призначення анімації GameObject на сцені. Animator вимагає посилання на контролер Animator, який визначає які саме анімаційні кліпи використовувати та контролює коли і як їх поєднувати та здійснювати переходи між ними. 

AnimatorController - Animator, створений в Unity, що дозволяє організувати та підтримувати набір анімацій для персонажа чи об'єкта. У більшості ситуацій вважається доцільним мати декілька анімацій та "перемикатися" між ними, коли виникають певні умови у гри. Наприклад, у розробленій грі можна переходити з анімації ходи до анімації атаки, коли гравець натискає клавішу пробілу. *Контролер* має посилання на анімаційні кліпи, що використовуються в ньому і керує різними станами анімації та переходами між ними за допомогою кінцевого автомата, який можна розглядати як своєрідну блок-схему.

## Вороги та штучний інтелект для їх руху
Ворогами головного героя є орки, що патрулують підземний світ та хочуть за найменшої нагоди вбити Ельфа. 

У грі Орк складається з трьох класів, а саме: EnemyController, EnemyView та Orc1Model.

В класі Orc1Model зберігається основні характеристики конкретно патрулюючого орка: сила, здоров'я, атака, радіус патрулювання тощо. Відображення анімацій атаки або руху, зменшення здоров'я відбувається у класі EnemyView. У EnemyController, в свою чергу, оброблюються усі дані які були відправлені з класу Orc1Model.

Для того, щоб зробити поведінку Орка більш природньою, було вирішено створити кінцевий автомат для їх поведінки. Це було доцільним, оскільки у ворога можливі всього 3 стани та немає переходів з кожного в кожний (в такому разі краще б підішло дерево рішень). 

Таким чином Орк має такі стани:
1. **Парулювання**. Стан Орка, при якому ворог випадковим чином ходить навколо однієї точки с певним, заздалегідь заданим, радіусом (ці параметри встановлюються кожній істоті при її ініціалізації).
2. **Переслідування**. Стан, при якому Орк намагється наздогнати гравця.
3. **Боротьба**. Стан, за якого Орк наносить удари головному герою (тобто зменшує життєві одиниці Ельфу).

Схема поведінки ворога зображена на Рисунку 2.

![Orc1 State Machine](https://github.com/kushkamisha/OnceUponATime/blob/master/Documents/Orc1StateMachine.png)
<center>Рисунок 2. Кінцевий автомат поведінки патрулюючого Орка</center>